<?php

class User{

      private static $instance;
      private $result;
      private $dbsite;

   public function __construct($dbsite, $login)
   {
       User::$instance = $this;
       $this->dbsite = $dbsite;
	   $result = $dbsite->query("SELECT name,login,password,email,date,city,country,acces_level,action,raiting,reg_date,online_time FROM users WHERE login='".$login."'");
       $this->result = @mysql_fetch_array($result);
   }

   public function getInstance()
   {
      return User::$instance;
   }
   
   public function __get($key)
   {
      if(isset($this->result[$key])) return $this->result[$key];
	  else return null;
   }
   
   public function isUser($login)
   {
      if($this->dbsite->check("login='".$login."'")) return 1;
	  else return 0;
   }
   
   public function isAdmin()
   {
      if($this->getAcces() <=2) return true;
	  else return false;
   }
    
   public function isMan($login)
   {
      $result = $this->dbsite->query("SELECT pol FROM users WHERE login='$login'");
	  $result = mysql_fetch_array($result);
	  if($result["pol"] == 'M') return true;
	  else return false;
   }
   
   public function isOnline($login)
   {
      return $this->dbsite->check("login='$login'", "online");
   }  
   
   public function numOnlines()
   {
      $result = $this->dbsite->query("SELECT login FROM online");
	  return @mysql_num_rows($result);
   }
	
   public function notReadMessages($autor=null)
   {
      if($autor == null) $result = $this->dbsite->query("SELECT adresat FROM messages WHERE adresat='".$this->login."' AND is_read='F' AND user='".$this->get("login")."'");
      else $result = $this->dbsite->query("SELECT adresat FROM messages WHERE adresat='".$this->get("login")."' AND is_read='F' AND user='".$this->get("login")."' AND autor='$autor'");
	  $num = @mysql_num_rows($result);
	  return $num;
   }
   
   public function getUserIcon($login)
   {
      return "<img src='Images/".($this->isMan($login)?"man_":"woman_").($this->isOnline($login) ?"on":"off").".gif"."'>";
   }
   
   public function maxRaitingUsers()
   {
      $users = $this->dbsite->query("SELECT login FROM users ORDER BY raiting DESC LIMIT 5");
	  $array = Array();
	  while($user = @mysql_fetch_array($users)){
	     $array[] = $user["login"];
	  }
	  return $array;
   }
   
    public function maxActionUsers()
   {
      $users = $this->dbsite->query("SELECT login FROM users ORDER BY action DESC LIMIT 5");
	  $array = Array();
	  while($user = @mysql_fetch_array($users)){
	     $array[] = $user["login"];
	  }
	  return $array;
   } 
    
   public function get($key)
   {
      if(isset($this->result[$key])) return $this->result[$key];
	  else return null;
   }
   
   public function set($key, $value)
   {
       $this->dbsite->query("UPDATE users SET $key='$value' WHERE login='".$this->get("login")."'");
   }
   
   public function getOnlineTime()
   {
      $time=$this->online_time;
	  return floor($time/3600) ." 